<app-window-template [window]="window">
    <ng-template #toolbar>
        Checksum information
    </ng-template>
    <ng-template #content>
        <div style="height: 100%; display: flex; flex-direction: column;">
            <mat-tab-group *ngIf="media">
                <mat-tab label="Music">
                    <as-split [gutterSize]="2" unit="pixel">

                        <!-- Group selection -->
                        <as-split-area [minSize]="200" [size]="240">
                            <ng-scrollbar
                                style="height: 100%; width: 100%"
                                track="vertical"
                                pointerEventsMethod="scrollbar"
                                [ngx-ctx-menu]="groupedCtxItems"
                            >
                                <div class="resize-observer" #fileViewport></div>
                                <cdk-virtual-scroll-viewport
                                    itemSize="60"
                                    scrollViewport
                                >
                                    <div class="group-item" *ngFor="let item of groupItems" (dblclick)="selectGrouping(item)">
                                        <div class="photo">
                                            <img [src]="item.image"/>
                                        </div>
                                        <div class="text">
                                            <div class="name">{{item.label}}</div>
                                            <div class="subtext">{{item.items.length}} items(s)</div>
                                        </div>
                                    </div>
                                </cdk-virtual-scroll-viewport>
                            </ng-scrollbar>
                        </as-split-area>

                        <!-- Current View -->
                        <as-split-area [minSize]="10">
                            <ngx-datatable
                                style="height: 100%; width: 100%"
                                [rows]="tracks"
                                [columns]="[
                                    { prop: 'common.artist', name: 'Artist' },
                                    { prop: 'common.title', name: 'Title' },
                                    { prop: 'common.album', name: 'Album' },
                                    { prop: 'common.genres', name: 'Genre' },
                                    { prop: 'duration', name: 'Time' }
                                ]"
                                [virtualization]="true"
                                [rowHeight]="26"
                                [headerHeight]="26"
                                [scrollbarV]="true"
                            />
                            <!-- <ng-scrollbar
                                style="height: 100%; width: 100%"
                                track="all"
                                pointerEventsMethod="scrollbar"
                                [ngx-ctx-menu]="musicCtxItems"
                            >
                                <div class="resize-observer" #fileViewport></div>
                                <cdk-virtual-scroll-viewport
                                    itemSize="27"
                                    scrollViewport
                                >
                                    <table>
                                        <thead>
                                            <tr style="position: sticky; top: 0">
                                                <th>Artist</th>
                                                <th>Title</th>
                                                <th>Album</th>
                                                <th>Genre</th>
                                                <th style="">Time</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr
                                                class="track"
                                                *cdkVirtualFor="let item of tracks"
                                                (dblclick)="addTrack(item)"
                                            >
                                                <td>{{item.common.artist}}</td>
                                                <td>{{item.common.title || item.name}}</td>
                                                <td>{{item.common.album}}</td>
                                                <td>{{item.common.genre.join()}}</td>
                                                <td>{{numToString(item.duration)}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </cdk-virtual-scroll-viewport>
                            </ng-scrollbar> -->
                        </as-split-area>

                        <!-- Queue -->
                        <as-split-area [minSize]="156" [size]="250">
                            <ng-scrollbar
                                style="height: 100%; width: 100%"
                                track="vertical"
                                pointerEventsMethod="scrollbar"
                                [ngx-ctx-menu]="queueCtxItems"
                            >
                                <div class="resize-observer" #fileViewport></div>
                                <cdk-virtual-scroll-viewport
                                    itemSize="60"
                                    scrollViewport
                                >
                                    <table class="queue">
                                        <tr *cdkVirtualFor="let item of queue">
                                            <td>
                                                <img class="img" [src]="getTrackPicture(item) | urlSanitizer" />
                                            </td>
                                            <td class="title">
                                                <mat-icon *ngIf="currentTrack == item">volume_down</mat-icon>
                                                <div>{{item.title}}</div>
                                            </td>
                                            <td class="duration">
                                                {{numToString(item.duration)}}
                                            </td>
                                        </tr>
                                    </table>
                                </cdk-virtual-scroll-viewport>
                            </ng-scrollbar>
                        </as-split-area>
                    </as-split>
                </mat-tab>
                <mat-tab label="Now Playing">
                    <ng-template matTabContent>
                        <app-visualizer
                            #visualizer
                            [mediaElement]="media"
                            (load)="visualizer.start(context, analyzer, source)"
                        />
                    </ng-template>
                </mat-tab>
                <mat-tab label="Playlists"></mat-tab>
                <mat-tab label="Music Explorer"></mat-tab>
                <mat-tab label="Podcasts"></mat-tab>
            </mat-tab-group>

            <div class="controls">

                <audio
                    #media
                    crossorigin="anonymous"
                    (timeupdate)="onTimeUpdate()"
                    (pause)="onPause()"
                    (ended)="onEnd()"
                >
                </audio>

                <div class="overlay">
                    <div class="nav-controls">
                        <button mat-icon-button (click)="playPrevious()"><mat-icon>skip_previous</mat-icon></button>

                        <button mat-icon-button *ngIf="state != 'playing'" (click)="onPlay()"><mat-icon>play_arrow</mat-icon></button>
                        <button mat-icon-button *ngIf="state == 'playing'" (click)="media.pause()"><mat-icon>pause</mat-icon></button>

                        <button mat-icon-button (click)="playNext()"><mat-icon>skip_next</mat-icon></button>
                    </div>

                    <div class="seeker">
                        <div class="top">
                            <div class="title">{{currentTrack?.common.title || "no file specified"}}</div>
                            <div class="duration" *ngIf="duration == 0">0:00:00</div>
                            <div class="duration" *ngIf="duration != 0">{{numToString(currentTime)}}/{{numToString(duration)}}</div>
                        </div>
                        <div class="slider">
                            <mat-slider
                                    [min]="0"
                                    [max]="duration"
                                    [step]=".1"
                                >
                                <input
                                    #progressSlider
                                    matSliderThumb
                                    [(value)]="currentTime"
                                    (valueChange)="media.currentTime = currentTime = $event"
                                    (pointermove)="
                                        currentTime = progressSlider.valueAsNumber;
                                        (
                                            (media.currentTime - currentTime) > 3 ||
                                            (media.currentTime - currentTime) < -3
                                        ) ? media.currentTime = currentTime : null;
                                        progress = progressSlider.valueAsNumber
                                    "
                                >
                            </mat-slider>
                        </div>
                        <!-- [value]="progress" (valueChange)="media.currentTime = media.duration*progress/100" -->
                    </div>

                    <div class="volume">
                        <mat-icon *ngIf="volume <= .1">volume_mute</mat-icon>
                        <mat-icon *ngIf="volume > .1 && volume < 50">volume_down</mat-icon>
                        <mat-icon *ngIf="volume >= 50">volume_up</mat-icon>

                        <mat-slider>
                            <input
                                #volumeSlider
                                matSliderThumb
                                [min]="0"
                                [max]="100"
                                [value]="volume"
                                (wheel)="volumeOnWheel($event)"
                                (pointermove)="volume = volumeSlider.valueAsNumber; media.volume = (volume / 100)"
                            >
                        </mat-slider>
                    </div>
                    <!-- TODO: Equalizer -->
                    <!-- <button><mat-icon>equalizer</mat-icon></button> -->

                    <div class="">
                        <button mat-icon-button (click)="isRepeating = !isRepeating">
                            <mat-icon *ngIf="!isRepeating">repeat</mat-icon>
                            <mat-icon *ngIf="isRepeating">repeat_on</mat-icon>
                        </button>

                        <button mat-icon-button (click)="isShuffling = !isShuffling">
                            <mat-icon *ngIf="!isShuffling">shuffle</mat-icon>
                            <mat-icon *ngIf="isShuffling">shuffle_on</mat-icon>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>
</app-window-template>
